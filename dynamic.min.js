var SASDynamic=function(){var e="",t="",n="SAS Job Execution compute context",l=null,i=null,a=null,o=new Map,r=null,s=null,d="_0_",u="_1_",c="_2_",m="_3_",p=1e3,g=new Map;g.set(d,0),g.set(u,0),g.set(c,0),g.set(m,0);var f=15,v=!1,h=null;function b(n){var i=n.libraryName||"",r=n.tableName||"";v&&console.log(">>>Into _getDynTableData "+JSON.stringify(n));var s=jQuery.Deferred();return i&&r?jQuery.when(j()).then(function(n){v&&console.log(">>>Got context: "+n),jQuery.when(w(l)).then(function(n){v&&console.log(">>>Got session id: "+n),jQuery.when(function(n,l,i,a){var r=jQuery.Deferred(),s=i+"."+a;return jQuery.when(y(c)).then(function(){var n=o.get(s);if(n)v&&console.log(">>>Got cached columns"),g.set(c,0),r.resolve(n);else{var d="/compute/sessions/"+l+"/data/"+encodeURIComponent(i)+"/"+encodeURIComponent(a)+"/columns?limit=9999";d=e+d;var u=""===t?{Accept:"application/json"}:{Accept:"application/json",Authorization:"bearer "+t};v&&console.log(">>>Get columns "+d);var m=jQuery.ajax({url:d,type:"GET",dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:u});m.done(function(e,t){if(e.items){for(var n=[],l=0;l<e.items.length;l++){var i={};i.name=e.items[l].name;var a=e.items[l].type.toLowerCase();a.indexOf("char")>=0||a.indexOf("date")>=0||a.indexOf("time")>=0?i.type="Char":i.type="Numeric",i.length=e.items[l].length,i.label=e.items[l].label,e.items[l].format&&(i.format=e.items[l].format.name),n.push(i)}o.set(s,n),g.set(c,0),r.resolve(n)}else g.set(c,0),console.error("Get data error: "+d),r.reject("No columns")}),m.fail(function(e,t,n){g.set(c,0),console.error("Get data error: "+d),r.reject(t)})}}),r.promise()}(0,a,i,r)).then(function(e){v&&console.log(">>>Got columns"),s.resolve({columnData:e})},function(e){v&&console.log(">>>Unable to obtain column "+e),s.reject("Column fail")})},function(e){v&&console.log(">>>Unable to obtain session id "+e),s.reject("Session fail")})},function(e){v&&console.log(">>>Unable to obtain compute context id "+e),s.reject("No context")}):s.reject("Get columns needs library and table"),s.promise()}function y(e){var t=jQuery.Deferred(),n=0;return setTimeout(function l(){0!==g.get(e)&&n++<120?(v&&console.log(">>>"+n+" Waiting for "+e),setTimeout(l,500)):(g.set(e,1),t.resolve())},5),t.promise()}function j(){var u=jQuery.Deferred();return jQuery.when(y(d)).then(function(){var c=encodeURIComponent(n);if(v&&console.log(">>>Getting context "+c),null!==l&&c===i)v&&console.log(">>>Got cached context "+l),g.set(d,0),u.resolve(l);else{var m="/compute/contexts?filter=eq(name,'"+c+"')";m=e+m;var p=""===t?{Accept:"application/json"}:{Accept:"application/json",Authorization:"bearer "+t};v&&console.log(">>>Get context "+m);var f=jQuery.ajax({url:m,type:"GET",dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:p});f.done(function(e,t,n){e.items&&e.count>0?(l=e.items[0].id,i=c,a=null,o=new Map,r=null,g.set(d,0),s=n.getResponseHeader("X-CSRF-TOKEN"),u.resolve(l)):(g.set(d,0),console.error("Context error: "+m),u.reject(""))}),f.fail(function(e,t,n){g.set(d,0),console.error("Context error: "+m),u.reject(t)})}}),u.promise()}function w(n){var l=jQuery.Deferred();return jQuery.when(y(u)).then(function(){var i=(new Date).getTime();if(null!==a&&(i-r>6e4*(f-2)?(v&&console.log(">>>Session expiration "+a),a=null):(v&&console.log(">>>Got cached session "+a),r=i,g.set(u,0),l.resolve(a))),null===a){var o="/compute/contexts/"+n+"/sessions";o=e+o;var d=""===t?{Accept:"application/json","X-CSRF-TOKEN":s}:{Accept:"application/json","X-CSRF-TOKEN":s,Authorization:"bearer "+t},c=JSON.stringify({attributes:{sessionInactiveTimeout:60*f}});v&&console.log(">>>Get session "+o);var m=jQuery.ajax({url:o,type:"POST",dataType:"json",data:c,contentType:"application/json",headers:d});m.done(function(e,t){e.id?(a=e.id,r=i,g.set(u,0),l.resolve(e.id)):(g.set(u,0),a=null,console.error("Session error: "+o),l.reject(""))}),m.fail(function(e,t,n){g.set(u,0),a=null,e.responseJSON&&console.error("Session error: "+e.responseJSON.message),l.reject(t)})}}),l.promise()}function A(e,n){v&&console.log(">>>Into _getCascadingValues "+JSON.stringify(e));var l=jQuery.Deferred();if(!e)return(l=jQuery.Deferred()).reject(void 0,e),l;var i=e.library||"",o=e.table||"";if(i&&o){var r={libraryName:i,tableName:o};jQuery.when(b(r)).then(function(r){jQuery.when(function(e,n,l,i,a,o,r){var d=jQuery.Deferred();v&&console.log(">>>>Into cascade _getvalues");var u={};if(null===r.view){var c,f,h=a.columnName,b=a.labelColumnName;a.labelColumnName||(b=h),a.sortDirection&&"none"!==a.sortDirection&&(f=a.sortDirection,c=a.sortBy&&"label"===a.sortBy?b:h);var y=!0;"boolean"!=typeof a.distinct||a.distinct||(y=!1);var j="";a.whereClauseStr&&"string"==typeof a.whereClauseStr&&a.whereClauseStr.length>0&&(j=a.whereClauseStr),u.distinct=y,j.length>0&&(u.where=j),c&&(u.sortBy=[{key:c,direction:f}]),u.includeColumns=a.labelColumnName?[h,b]:[h],a.format&&a.format.length>0&&(u.columnFormatting=[{name:h,format:a.format}])}var w,A=a.start?a.start:0,E=p;a.threshold&&(E=a.threshold);var S="post";r.view?(w=r.view+"&limit="+E+"&start="+A,S="get"):(w="/compute/sessions/"+n+"/data/"+encodeURIComponent(l)+"/"+encodeURIComponent(i)+"/promptContent/?limit="+E+"&start="+A,null===r.paging||"false"===r.paging?w+="&preserveView=never":"true"===r.paging&&(w+="&preserveView=always"));v&&console.log("\n>>>>Get data "+w+"\n"+JSON.stringify(u));var T=""===t?{Accept:"application/json","X-CSRF-TOKEN":s}:{Accept:"application/json","X-CSRF-TOKEN":s,Authorization:"bearer "+t},x=jQuery.ajax({url:w,type:S,data:null===r.view?JSON.stringify(u):"",dataType:"json",contentType:"application/json",headers:T});return x.done(function(e,t){v&&console.log(">>>Got data\n"+JSON.stringify(e.items));for(var n=[],l=0;l<e.rows.length;l++){var i=e.rows[l].raw[0],o=e.rows[l].formatted[0];h!==b&&(o=e.rows[l].formatted[1]),null===a.format||void 0===a.format||a.format.length>0?("string"==typeof o&&(o=o.trim()),n.push({unformatted:i,formatted:o})):(o=i,h!==b&&(o=e.rows[l].raw[1]),"string"==typeof o&&(o=o.trim()),n.push({unformatted:i,formatted:o}))}v&&console.log(">>>>Got formatted & unformatted");for(var s=0;s<e.links.length;s++)"self"===e.links[s].rel?r.view=e.links[s].uri:"deleteView"===e.links[s].rel&&(r.delview=e.links[s].uri);null===r.delview&&(r.view=null),d.resolve(n),g[m]=0}),x.fail(function(e,t,n){console.log(">>>Unable to get data "+t),d.reject("Cascade fail "+t),g[m]=0}),d.promise()}(0,a,i,o,e,0,n)).then(function(e){v&&console.log("\n>>>>Returning:\n"+JSON.stringify({data:e})),l.resolve({data:e})},function(e){console.log(">>>Unable to obtain cascading values "+e),l.reject("Cascade fail "+e)})},function(e){console.log(">>>Unable to obtain column data "+e),l.reject("No context")})}else l.reject("Get cascade needs library and table");return l.promise()}function E(e){if(e){var n=""===t?{Accept:"application/json","X-CSRF-TOKEN":s}:{Accept:"application/json","X-CSRF-TOKEN":s,Authorization:"bearer "+t},l=jQuery.ajax({url:e,type:"DELETE",dataType:"json",contentType:"application/json",headers:n});l.done(function(e,t){v&&console.log(">>>>Deleted view")}),l.fail(function(e,t,n){v&&console.log(">>>>Deleted view failed "+t)})}}function S(n,l){var i=jQuery.Deferred(),a="/compute/sessions/"+l+"/data?limit=9999";a=e+a;var o=""===t?{Accept:"application/json"}:{Accept:"application/json",Authorization:"bearer "+t};v&&console.log(">>>Into _getLibraries "+a);var r=jQuery.ajax({url:a,type:"GET",dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:o});return r.done(function(a,o){if(a.items){!function n(l,i,a,o,r){if(o.length>0){var s=o[0].name,d="/compute/sessions/"+a+"/data/"+s;d=e+d;var u=""===t?{Accept:"application/vnd.sas.compute.library+json"}:{Accept:"application/vnd.sas.compute.library+json",Authorization:"bearer "+t};v&&console.log(">>>Into _getLibData "+d);var c=jQuery.ajax({url:d,type:"GET",dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:u});c.done(function(e,t){if(e){var s={id:e.id,name:e.name,concats:e.concatenations,engineName:e.engineName,fileFormat:e.fileFormat,flags:e.flags,libref:e.libref,options:e.options,physicalName:e.physicalName,readOnly:e.readOnly};r.push(s),o.shift(),n(l,i,a,o,r)}else l.reject("No library")}),c.fail(function(e,t,n){console.error("Get data error "+d),l.reject(t)})}else l.resolve(r);return}(i,n,l,a.items,[])}else i.reject("No libraries")}),r.fail(function(e,t,n){console.error("Get data error "+a),i.reject(t)}),i.promise()}function T(e){var t=$("#"+e).val();if(Array.isArray(t))return t;var n=[];return null!=t&&n.push(t),n}function x(e,t){var n,l=e.element,i=e.element.getBoundingClientRect(),a=e.element.getAttribute("list");null!==a&&(l=document.getElementById(a)),null===e.defaults&&null===e.multiple&&l===e.element&&((n=document.createElement("option")).value="",n.innerHTML="",l.appendChild(n)),e.multiple&&e.element.options&&1===e.element.options.length&&"OPTION"===e.element.firstChild.tagName&&""===e.element.firstChild.value&&e.element.removeChild(e.element.firstChild);for(var o=0,r=0;r<t.data.length;r++){if((n=document.createElement("option")).value=t.data[r].unformatted,null!==a){var s=n.value.length;if(s>o&&(o=s),null!==e.defaults&&e.defaults.length>0){var d=C(e.defaults[0]);e.element.value=d[0]}}else if(l===e.element&&(n.text=t.data[r].formatted,null!==e.defaults))for(var u=0;u<e.defaults.length;u++){d=C(e.defaults[u]);if(!e.remdefault.includes(d[0])&&d[0]===n.value.trim()&&(n.setAttribute("selected",!0),null===e.multiple))break}l.appendChild(n)}if(e.loaded=!0,e.filter){var c=document.getElementById(e.id+"_filter");c&&(c.disabled=!1)}null!==e.size&&(e.element.size=e.size,e.dual&&(document.getElementById(e.dualid).size=e.size));if(e.dual&&i.width>0){var m=document.getElementById(e.dualid);m.style.width=i.width+"px","SELECT"===e.tagname&&(m.style.height=i.height+"px")}if(o>0&&e.element.setAttribute("width",o),"true"===e.paging||"auto"===e.paging){var p=document.getElementById(e.leftid);e.start>0?p.disabled=!1:p.disabled=!0;var g=document.getElementById(e.rightid);t.data.length>=e.threshold?(g.disabled=!1,"auto"===e.paging&&(g.style.display="inline",p.style.display="inline")):g.disabled=!0}null!==e.callback&&window[e.callback](t.data.length,e.id),(e.dual||(e.enables.size>0||e.displays.size>0)&&0===t.data.length||null!==e.defaults&&e.defaults.length>0)&&SASDynamic._onchangeEV(null,e)}function C(e){var t=[];if(e){t[0]=e.trim(),t[1]=e.trim();var n=e.indexOf(":");n>=0&&(t[0]=e.substring(0,n).trim(),t[1]="",e.length>n&&(t[1]=e.substr(n+1).trim()))}return t}function D(e){if(null!==e.defaults&&e.defaults.length>0&&null!==e.dualid&&void 0!==e.dualid){var t=document.getElementById(e.dualid),n=t.disabled;t.disabled=!1,t.savedisabled=e.savedisabled;for(var l=0;l<e.defaults.length;l++){var i=C(e.defaults[l]),a=i[0];if(!e.remdefault.includes(a)){var o=document.createElement("option");o.value=a,o.text=i[1],o.selected=!0,o.setAttribute("onclick","SASDynamic._dual_remove(event, '"+e.id+"')");for(var r=!1,s=0;s<t.options.length;s++){if(t.options[s].value.trim()>o.value.trim()){var d=t.options[s];t.add(o,d),r=!0;break}if(t.options[s].value.trim()===o.value.trim()){r=!0;break}}if(r||t.appendChild(o),void 0!==e.applyid)document.getElementById(e.applyid).disabled=!1}}e.hidden&&(t.disabled=n)}e.defloaded=!0}function I(e,t){var n=e.element,l=e.element.getAttribute("list");if(null!==l){if(null===(n=document.getElementById(l)))return console.log(">>>Datalist not found: "+l),!1;e.element.value=""}for(;n.firstChild;)n.removeChild(n.firstChild);if(e.loaded=!1,e.multiple&&!e.dual&&(n.size=1),e.dual&&!0!==t){for(var i=document.getElementById(e.dualid);i.firstChild;)i.removeChild(i.firstChild);if(e.applyid)document.getElementById(e.applyid).disabled=!0;t||(e.remdefault=[],e.defloaded=!1)}if("true"===e.filter&&!0!==t){var a=document.getElementById(e.id+"_filter");a&&(a.disabled=!0)}if(e.multiple&&(void 0===e.element.options||e.element.options.length<=0)){var o=document.createElement("option");o.value="",o.innerHTML="&nbsp;",o.disabled=!0,e.element.appendChild(o)}if(("true"===e.paging||"auto"===e.paging)&&!0!==t){var r=document.getElementById(e.leftid);r.disabled=!0;var s=document.getElementById(e.rightid);s.disabled=!0,"auto"===e.paging&&(r.style.display="none",s.style.display="none")}return null!==e.displays&&B(e),!0}function N(e){v&&console.log(">>>Into _dependents "+e.colname);for(var t=[],n=0;n<e.feeds.length;n++){n>0&&setTimeout(function(){},50);var l=h.get(e.feeds[n]);l.start=0,l.delview&&(E(l.delview),l.view=null,l.delview=null),t.push(G(l))}jQuery.when.apply(null,t).done(function(){v&&console.log(">>>Dependents done")})}function _(e){v&&console.log(">>>Into _enable "+e.colname);var t=[];if(void 0===e.applyid||e.applied){var n=T(e.id);e.enables.forEach((l,i)=>{var a=document.getElementById(l.id),o=h.get(a.id);e.dual&&(n=T(e.dualid)),0===n.length&&n.push("");for(var r=0;r<n.length;r++){var s=n[r].trim();"eq"===l.oper&&s===l.match||"ne"===l.oper&&s!==l.match||"lt"===l.oper&&s<l.match||"gt"===l.oper&&s>l.match?(o.hidden?a.savedisabled=!1:a.disabled=!1,o.enabled||null!==o.uses||"DIV"===o.tagname||"SPAN"===o.tagname||t.push(G(o)),o.enabled=!0,a.style.color=""):(o.hidden?a.savedisabled=!0:a.disabled=!0,o.enabled=!1,a.style.color="rgb(170,170,170)")}for(var d=a.querySelectorAll("input, label, textarea, select, div, span"),u=0;u<d.length;u++){o.enabled?(d[u].style.color="",o.hidden?d[u].savedisabled=!1:d[u].disabled=!1):(d[u].style.color="rgb(170,170,170)",o.hidden?d[u].savedisabled=!0:d[u].disabled=!0);var c=h.get(d[u].id);null!=c&&(c.enabled||null!==c.uses||t.push(G(c)),c.enabled=o.enabled)}}),jQuery.when.apply(null,t).done(function(){v&&console.log(">>>Done _enable "+e.colname)})}}function B(e){v&&console.log(">>>Into _visibility "+e.colname);var t=T(e.id),n=[];(void 0===e.applyid||e.applied)&&(e.displays.forEach((l,i)=>{var a=document.getElementById(l.id),o=e.element.getBoundingClientRect();if(e.dual){var r=e.dualid,s=document.getElementById(r);o.height>0&&(s.style.height=o.height+"px",s.style.width=o.width+"px"),t=T(r)}if(e.filter){var d=document.getElementById(e.id+"_filter");d&&(d.disabled=!1)}0===t.length&&t.push("");for(var u=0;u<t.length;u++){var c=t[u].trim(),m=h.get(a.id),p=!1,g=m.hidden;"eq"===l.oper&&c===l.match||"ne"===l.oper&&c!==l.match||"lt"===l.oper&&c<l.match||"gt"===l.oper&&c>l.match?(p=!0,a.style.display="initial",m.hidden=!1,g&&(a.disabled=a.savedisabled,a.savedisabled=void 0,m.dual&&(document.getElementById(m.dualid).disabled=a.disabled)),m.loaded||null!==m.uses||"DIV"===m.tagname||"SPAN"===m.tagname||n.push(G(m))):(a.style.display="none",m.hidden=!0,g||(a.savedisabled=a.disabled,a.disabled=!0,m.dual&&(document.getElementById(m.dualid).disabled=!0)));for(var f=a.querySelectorAll("input, textarea, select, div, span"),v=0;v<f.length;v++){var b=h.get(f[v].id);b&&(b.hidden=m.hidden),p?(g&&(f[v].disabled=f[v].savedisabled,f[v].savedisabled=void 0),b&&(b.loaded||null!==b.uses||n.push(G(b)))):g||(f[v].savedisabled=f[v].disabled,f[v].disabled=!0)}}}),jQuery.when.apply(null,n).done(function(){v&&console.log(">>>Done _visibility "+e.colname)}))}function Q(e){setTimeout(function(){e.element.style.cursor="auto"},50)}function L(e,t){var n=document.getElementById(e.id+"_filter");if(n){var l=n.value.toLowerCase().trim();if(t&&l.length<=0)return;var i=e.element,a=e.element.getAttribute("list");if(null!==a&&(i=document.getElementById(a)),i.options)for(var o=0;o<i.options.length;o++){var r=i.options[o].value;r&&(r=r.toLowerCase(),l.length>0&&r.indexOf(l)<0?i.options[o].style.display="none":i.options[o].style.display=null)}}}function U(e,t,n){if(outdata={},n){var l=n.split(",");if(l.length>3){var i=n.indexOf(l[2]);l=[l[0],l[1],n.substr(i)]}if(3===l.length){var a=e.id.trim(),o=l[0].trim(),r=h.get(o);if(void 0!==r&&("visible"===t&&!r.displays.has(a)||"enable"===t&&!r.enables.has(a))){var s=l[1].trim().toLowerCase(),d=l[2].trim();if(d.length>1&&(d.startsWith('"')&&d.endsWith('"')||d.startsWith("'")&&d.endsWith("'"))&&(d=2===d.length?"":d.substr(1,d.length-2)),outdata.id=a,outdata.oper=s,outdata.match=d,"visible"===t){r.displays.set(a,outdata),e.element.style.display="none",e.hidden=!0,e.element.savedisabled=e.element.disabled;for(var u=e.element.querySelectorAll("input, textarea, select, div, span"),c=0;c<u.length;c++)u[c].savedisabled=u[c].disabled,u[c].disabled=!0;e.element.disabled=!0,e.dual&&(document.getElementById(e.dualid).disabled=!0)}else{r.enables.set(a,outdata),e.element.disabled=!0,e.enabled=!1,e.element.style.color="rgb(170,170,170)";for(var m=e.element.querySelectorAll("input, label, textarea, select"),p=0;p<m.length;p++){m[p].style.color="rgb(170,170,170)",m[p].disabled=!0;var g=h.get(m[p].id);null!=g&&(g.enabled=!1)}}return r.element.addEventListener("change",SASDynamic._onchangeEV),outdata}}}return null}function G(e,t){v&&console.log(">>>Into _getData "+e.colname);var n=jQuery.Deferred();return jQuery.when(y(e.id)).then(function(){if(function(e){setTimeout(function(){e.element.style.cursor="progress"},50)}(e),null===e.library&&"*"!==e.table||null===e.table&&"*"!==e.library)return Q(e),g.set(e.id,0),void n.reject(null);if("*"===e.library)return jQuery.when(SASDynamic.getLibraries()).then(function(t){if(v&&console.log(">>>_getData got libraries"),!I(e))return Q(e),g.set(e.id,0),void n.resolve(e);for(var l=[],i=0;i<t.length;i++)l.push({formatted:t[i].name,unformatted:t[i].name});var a={};a.data=l,x(e,a),Q(e),g.set(e.id,0),n.resolve(e)},function(t){console.log(">>>Unable to obtain libraries "+t),Q(e),g.set(e.id,0),n.reject("Library fail")}),n.promise();if("*"===e.table){var l=e.library;if(null===l&&null!==e.uses&&e.uses.length>0){var i=h.get(e.uses[0]),a=e.dual?i.dualid:i.id;val=T(a),val.length>0&&(l=val[0])}return jQuery.when(SASDynamic.getTables(l)).then(function(t){if(v&&console.log(">>>_getData got tables"),!I(e))return Q(e),g.set(e.id,0),void n.resolve(e);for(var l=[],i=0;i<t.length;i++)l.push({formatted:t[i],unformatted:t[i]});var a={};a.data=l,x(e,a),Q(e),g.set(e.id,0),n.resolve(e)},function(t){console.log(">>>Unable to obtain libraries "+t),Q(e),g.set(e.id,0),n.reject("Library fail")}),n.promise()}var o={};o.libraryName=e.library,o.tableName=e.table,jQuery.when(b(o)).then(function(l){var i={};i.columnName=e.colname,i.labelColumnName=e.labelcolname,i.library=e.library,i.table=e.table,i.threshold=e.threshold,i.sortBy=null!==e.sortBy?e.sortBy:"label",i.sortDirection=null!==e.sortDirection?e.sortDirection:"ascending",null!==e.format&&(i.format=e.format),null!==e.distinct&&(i.distinct=e.distinct),i.start=e.start,jQuery.when(function(e,t){v&&console.log(">>>Into _getWhere "+e.colname);var n=jQuery.Deferred(),l=[];if(null!==e.uses)for(var i=0;i<e.uses.length;i++)l.push(y(e.uses[i]));return jQuery.when.apply(null,l).done(function(){if(l.length<=0)n.resolve(null);else{for(var i="",a=0;a<e.uses.length;a++){var o=h.get(e.uses[a]);if(void 0===o){console.log(">>>Field not found: "+e.uses[a]);for(var r=0;r<e.uses.length;r++)g.set(e.uses[r],0);return void n.resolve(null)}for(var s=t.columnData,d="Char",u=null===e.wherecolname?o.colname.toLowerCase():e.wherecolname.toLowerCase(),c=0;c<s.length;c++)if(s[c].name.toLowerCase()===u){d=s[c].type;break}var m=T(o.dual?o.dualid:o.id);if(m.length<=0||""===m[0]){for(var p=0;p<e.uses.length;p++)g.set(e.uses[p],0);return void n.resolve(null)}var f=" = ",v="";if(1===m.length)v=m[0].trim();else{f=" IN ",v="(";for(var b=0;b<m.length;b++)b>0&&(v+=","),v+="Numeric"===d?m[b].trim():'"'+m[b].trim()+'"';v+=")"}a>0&&(i+=" AND "),"Numeric"===d||m.length>1?i+="('"+u+"'n"+f+v+")":i+="('"+u+"'n"+f+'"'+v+'")'}for(var y=0;y<e.uses.length;y++)g.set(e.uses[y],0);var j=null;i.length>0&&(j=e.uses.length>1?"("+i+")":i),n.resolve(j)}}),n.promise()}(e,l)).then(function(l){if(null!=l)i.whereClauseStr=l;else if(null!==e.uses)return I(e,t),g.set(e.id,0),Q(e),void n.resolve(e);v&&console.log(">>>Starting get values: "+e.colname),jQuery.when(A(i,e)).then(function(l){if(v&&console.log(">>>Done _getdata: "+e.colname),l.data){if(!I(e,t))return g.set(e.id,0),Q(e),void n.resolve(e);x(e,l)}("true"===e.paging||"auto"===e.paging)&&l.data.length<e.threshold&&(document.getElementById(e.rightid).disabled=!0,l.data.length<=0&&(e.start=e.start-e.threshold,e.start<0&&(e.start=0)));g.set(e.id,0),Q(e),n.resolve(e)},function(t){console.log(">>>Unable to obtain values "+t),g.set(e.id,0),Q(e),n.reject(e)})})},function(t){console.log(">>>Unable to obtain columns "+t),g.set(e.id,0),Q(e),n.reject(e)})},function(t){console.log(">>>Unable to obtain lock "+t),Q(e),n.reject(e)}),n.promise()}return{init:function(l,i,a){v&&console.log(">>>Into init dynamic"),void 0!==l&&l.trim().length>0&&(n=l),void 0!==i&&(e=i),void 0!==a&&(t=a),h=new Map;var o=document.getElementsByTagName("FORM");if(void 0!==o){for(var r=1,s=0;s<o.length;s++)for(var d=o[s].querySelectorAll("input, textarea, select, div, span"),u=0;u<d.length;u++)if(!d[u].type||"hidden"!==d[u].type.toLowerCase().trim()){var c=d[u].getAttribute("data-library"),m=d[u].getAttribute("data-table"),f=d[u].getAttribute("data-dual"),b={};b.element=d[u],b.id=b.element.id,void 0!==b.id&&""!==b.id||(b.id="__"+r++,b.element.id=b.id),b.name=d[u].getAttribute("name"),b.size=d[u].getAttribute("size"),b.dual=null!==f&&"true"===f.trim(),b.multiple=d[u].getAttribute("multiple"),null!==b.multiple&&(b.multiple=!0),b.dual&&(b.multiple=!0,b.element.setAttribute("multiple","true")),b.multiple&&(null===b.size&&(b.size="4"),b.dual||0!==b.element.options.length||(b.element.size=1)),b.format=d[u].getAttribute("data-format"),null!==b.format&&(b.format=b.format.trim()),b.colname=d[u].getAttribute("data-colname"),null!==b.colname&&(b.colname=b.colname.trim()),b.labelcolname=d[u].getAttribute("data-labelcolname"),null!==b.labelcolname&&(b.labelcolname=b.labelcolname.trim()),b.wherecolname=d[u].getAttribute("data-wherecolname"),null!==b.wherecolname&&(b.wherecolname=b.wherecolname.trim()),b.tagname=d[u].tagName,b.callback=d[u].getAttribute("data-callback"),b.library=c,null!==b.library&&(b.library=c.trim()),b.table=m,null!==b.table&&(b.table=m.trim()),b.view=null,b.delview=null,b.required=null!==d[u].getAttribute("required"),b.threshold=d[u].getAttribute("data-threshold"),b.threshold=null===b.threshold?p:parseInt(b.threshold,10),b.visible=d[u].getAttribute("data-visible"),null!==b.visible&&(b.visible=b.visible.trim()),b.enable=d[u].getAttribute("data-enable"),null!==b.enable&&(b.enable=b.enable.trim());var y=d[u].getAttribute("data-distinct");null!==y&&(b.distinct="true"===y);var j,w=d[u].getAttribute("data-filter");if(null!==w&&(b.filter="true"===w),b.sortBy=d[u].getAttribute("data-sortBy"),b.sortDirection=d[u].getAttribute("data-sortDirection"),b.paging=d[u].getAttribute("data-paging"),null!==b.paging&&(b.paging=b.paging.trim()),b.uses=d[u].getAttribute("data-uses"),null!==b.uses&&(b.uses=b.uses.replace(/ /g,""),b.uses=b.uses.split(",")),b.loaded=!1,void 0!==b.element.options&&b.element.options.length>0)b.loaded=!0;else{var A=b.element.getAttribute("list");if(null!==A){var E=document.getElementById(A);null!==E&&E.options.length>0&&(b.loaded=!0)}}if(b.hidden=!1,b.enabled=!0,b.start=0,b.feeds=[],b.displays=new Map,b.enables=new Map,b.remdefault=[],b.defloaded=!1,b.defaults=d[u].getAttribute("data-default"),null!==b.defaults&&(b.defaults=b.defaults.split(",")),h.set(b.id,b),g.set(b.id,0),b.dual||b.filter||"true"===b.paging||"auto"===b.paging){var S=document.createElement("DIV");S.style.display="flex",S.style.flexDirection="column",S.id=b.id+"_col",b.element.parentNode.insertBefore(S,b.element),S.appendChild(b.element);var T=document.createElement("INPUT");T.placeholder="??",T.style=b.element.style,T.style.width=b.element.style.width;var x=b.element.getBoundingClientRect();if(x&&x.width>0&&(T.style.width=x.width+"px"),T.style.paddingLeft=1,T.style.paddingRight=0,T.style.marginLeft=0,T.style.marginRight=0,S.style.width=T.style.width,T.style.display=b.filter&&"SELECT"===b.tagname?"initial":"none",T.title="Filter",T.autocomplete="off",T.id=b.id+"_filter",T.disabled=!0,T.setAttribute("onkeyup","SASDynamic._filter(event, '"+b.id+"')"),b.element.parentNode.insertBefore(T,b.element),(j=document.createElement("DIV")).style.display="inline-flex",j.style.flexDirection="row",j.style.alignItems="flex-end",j.id=b.id+"_row",S.parentNode.insertBefore(j,S),j.appendChild(S),b.multiple&&(void 0===b.element.options||b.element.options.length<=0)){var C=document.createElement("option");C.value="",C.innerHTML="&nbsp;",C.disabled=!0,b.element.appendChild(C)}if("INPUT"===b.tagname&&b.dual){var I=document.createElement("BUTTON");I.type="button",I.innerHTML="+",I.setAttribute("title","Add");I.setAttribute("style","margin-left:2px;padding: 0px 6px;"),I.setAttribute("disabled",!0),I.setAttribute("onclick","SASDynamic._apply(event, '"+b.id+"')"),I.setAttribute("id",b.id+"_add"),b.addid=I.id,j.appendChild(I),b.element.addEventListener("keyup",function(e){var t=document.getElementById(e.target.id),n=h.get(t.id);document.getElementById(n.addid).disabled=t.value.trim().length<=0}),b.element.addEventListener("keydown",function(e){13===e.keyCode&&(e.preventDefault(),SASDynamic._onchangeEV(null,b))})}if("true"===b.paging||"auto"===b.paging){var N=document.createElement("INPUT");N.setAttribute("value","<");var _=document.createElement("INPUT");_.setAttribute("value",">"),N.setAttribute("type","button"),_.setAttribute("type","button"),N.setAttribute("title","Page back"),_.setAttribute("title","Page forward");N.setAttribute("style","margin-left:2px;padding: 0px 6px;"),_.setAttribute("style","margin-left:2px;padding: 0px 6px;"),N.setAttribute("disabled",!0),_.setAttribute("disabled",!0),N.setAttribute("onclick","SASDynamic._paging(event, '"+b.id+"','back')"),_.setAttribute("onclick","SASDynamic._paging(event, '"+b.id+"','forward')"),N.setAttribute("id",b.id+"_left"),_.setAttribute("id",b.id+"_right"),b.leftid=N.id,b.rightid=_.id,j.appendChild(N),j.appendChild(_),"auto"===b.paging&&(N.style.display="none",_.style.display="none")}if(b.dual){var B=document.createElement("SELECT");B.setAttribute("multiple","true"),B.size=null===b.size?"4":b.size;var Q=b.element.getBoundingClientRect(),L=b.element.getAttribute("style");null!==L&&B.setAttribute("style",L),Q.width>0&&(B.style.width=Q.width+"px"),Q.height>0&&"SELECT"===b.tagname&&(B.style.height=Q.height+"px"),"SELECT"!==b.tagname&&(b.element.name=""),B.style.marginLeft="2px",null!==b.name&&B.setAttribute("name",b.name),b.required&&(b.element.removeAttribute("required"),B.setAttribute("required","true")),B.setAttribute("id",b.id+"_dual"),j.appendChild(B),b.dualid=B.id,b.element.addEventListener("change",SASDynamic._onchangeEV),"INPUT"===b.tagname&&D(b)}}}var k=document.getElementsByTagName("BODY");void 0!==k&&(k[0].onbeforeunload=function(e){SASDynamic.deleteSession()}),h.forEach((e,t)=>{if(null!==e.uses)for(var n=e.id.trim(),l=0;l<e.uses.length;l++){var i=h.get(e.uses[l]);void 0===i||i.feeds.includes(n)||(i.feeds.push(n),i.element.addEventListener("change",SASDynamic._onchangeEV))}null!==e.visible&&U(e,"visible",e.visible),null!==e.enable&&U(e,"enable",e.enable)}),h.forEach((e,t)=>{if(e.dual&&e.feeds.length>0){var n=document.createElement("BUTTON");n.type="button",n.innerHTML="&#9660;",n.setAttribute("title","Apply");n.setAttribute("style","margin-left:2px;padding: 0px 4px;"),n.setAttribute("disabled",!0),n.setAttribute("onclick","SASDynamic._apply(event, '"+e.id+"')"),n.setAttribute("id",e.id+"_apply"),e.applyid=n.id,e.applied=!1,document.getElementById(e.id+"_row").appendChild(n)}}),document.body.style.visibility="visible";var O=[],z=$(document.body).is(":visible");h.forEach((e,t)=>{e.hidden=!$(e.element).is(":visible"),null!==e.uses||null===e.library||e.hidden&&z||O.push(G(e))}),jQuery.when.apply(null,O).done(function(){v&&console.log(">>>First level done")})}},_onchangeEV:function(e,t){var n;if(void 0!==t)n=document.getElementById(t.id).value;else{var l=document.getElementById(e.target.id);n=l.value,t=h.get(l.id)}v&&console.log(">>>Change EV "+t.id+" to "+n),null!==t.enables&&_(t),null!==t.displays&&B(t),t.dual?(!function(e){var t=document.getElementById(e.dualid);t.size=null!==e.size?e.size:"4",t.style.marginLeft="2px";var n=T(e.id),l=e.element.getBoundingClientRect();if(l.width>0&&(t.style.width=l.width,"SELECT"===e.tagname&&(t.style.height=l.height)),n.length>0){if(0===n[0].trim().length&&"SELECT"!==e.tagname)return;var i=t.disabled;if(t.disabled=!1,t.savedisabled=e.savedisabled,void 0!==e.applyid&&(document.getElementById(e.applyid).disabled=!1),"SELECT"===e.tagname)for(var a=0;a<e.element.options.length;a++){var o=e.element.options[a];if(o.selected){var r=document.createElement("option");r.value=o.value,r.text=o.text,r.selected=!0,r.setAttribute("onclick","SASDynamic._dual_remove(event, '"+e.id+"')"),o.selected=!1,o.disabled=!0;for(var s=!1,d=0;d<t.options.length;d++){if(t.options[d].value.trim()>r.value.trim()){var u=t.options[d];t.add(r,u),s=!0;break}if(t.options[d].value.trim()===r.value.trim()){s=!0;break}}s||t.appendChild(r)}}else{var c=document.createElement("option");c.value=n[0],c.text=n[0],c.selected=!0,c.setAttribute("onclick","SASDynamic._dual_remove(event, '"+e.id+"')");for(var m=!1,p=0;p<t.options.length;p++){if(t.options[p].value.trim()>c.value.trim()){var g=t.options[p];t.add(c,g),m=!0;break}if(t.options[p].value.trim()===c.value.trim()){m=!0;break}}m||t.appendChild(c),"INPUT"===e.tagname&&(e.element.value="",e.addid&&(document.getElementById(e.addid).disabled=!0))}e.hidden&&(t.disabled=i)}}(t),t.defloaded||D(t)):N(t)},_apply:function(e,t){v&&console.log(">>>Into SASDynamic._apply"+t);var n=h.get(t);n.applied=!0,null!==n.enables&&_(n),null!==n.displays&&B(n),N(n)},_paging:function(e,t,n){v&&console.log(">>>Into SASDynamic._paging"+t);var l=h.get(t);"forward"===n?l.start=l.start+l.threshold:!e.ctrlKey&&l.start-l.threshold>=0?l.start=l.start-l.threshold:l.start=0,jQuery.when(G(l,!0)).done(function(){v&&console.log(">>>_paging done"+t),L(l,!0)})},_filter:function(e,t){v&&console.log(">>>Into SASDynamic._filter"+t),L(h.get(t),!1)},_dual_remove:function(e,t){v&&console.log(">>>Into SASDynamic._dual_remove");var n=h.get(t),l=e.target,i=l.value;l.remove(),n.remdefault.includes(i)||n.remdefault.push(i);for(var a=document.getElementById(n.dualid),o=0;o<a.options.length;o++){a.options[o].selected=!0}if(n.element.options)for(var r=0;r<n.element.options.length;r++){var s=n.element.options[r];if(s.value.trim()===i.trim()){s.disabled=!1;break}}},getLibraries:function(e){v&&console.log(">>>Into SASDynamic.getLibraries ");var t=jQuery.Deferred();return void 0!==e&&e.trim().length>0&&(n=e),jQuery.when(j()).then(function(e){v&&console.log(">>>Got context: "+e),jQuery.when(w(l)).then(function(e){v&&console.log(">>>Got session id: "+e),jQuery.when(S(l,a)).then(function(e){v&&console.log(">>>Got libraries"),t.resolve(e)},function(e){console.log(">>>Unable to obtain libraries "+e),t.reject("Library fail")})},function(e){v&&console.log(">>>Unable to obtain session id "+e),t.reject("Session fail")})},function(e){v&&console.log(">>>Unable to obtain compute context id "+e),t.reject("No context")}),t.promise()},getTables:function(i,o){v&&console.log(">>>Into Into SASDynamic.getTables  "+i);var r=jQuery.Deferred();return void 0!==o&&o.trim().length>0&&(n=o),jQuery.when(j()).then(function(n){v&&console.log(">>>Got context: "+n),jQuery.when(w(l)).then(function(n){v&&console.log(">>>Got session id: "+n),jQuery.when(function(n,l,i){var a=jQuery.Deferred(),o="/compute/sessions/"+l+"/data/"+encodeURIComponent(i)+"?limit=9999";o=e+o;var r=""===t?{Accept:"application/vnd.sas.collection+json"}:{Accept:"application/vnd.sas.collection+json",Authorization:"bearer "+t};v&&console.log(">>>Get tables "+o);var s=jQuery.ajax({url:o,type:"GET",dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:r});return s.done(function(e,t){if(e.items){for(var n=[],l=0;l<e.items.length;l++)n.push(e.items[l].name);a.resolve(n)}else a.reject("No tables")}),s.fail(function(e,t,n){console.error("Get data error "+o),a.reject(t)}),a.promise()}(0,a,i)).then(function(e){v&&console.log(">>>Got tables"),r.resolve(e)},function(e){v&&console.log(">>>Unable to obtain tables "+e),r.reject("Table fail")})},function(e){console.log(">>>Unable to obtain session id "+e),r.reject("Session fail")})},function(e){v&&console.log(">>>Unable to obtain compute context id "+e),r.reject("No context")}),r.promise()},getTableData:function(i,a,o){v&&console.log(">>>Into SASDynamic.getTableData ");var r=jQuery.Deferred();return void 0!==o&&o.trim().length>0&&(n=o),jQuery.when(j()).then(function(n){v&&console.log(">>>Got context: "+n),jQuery.when(w(l)).then(function(n){v&&console.log(">>>Got session id: "+n);var l="/compute/sessions/"+n+"/data/"+i+"/"+a+"/rowSet/?limit=99999";l=e+l;var o=""===t?{Accept:"application/json"}:{Accept:"application/json",Authorization:"bearer "+t};v&&console.log(">>>Get table data "+l);var s=jQuery.ajax({url:l,type:"GET",dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",headers:o});s.done(function(e,t){e?r.resolve(e.columns,e.rows):r.reject("No data")}),s.fail(function(e,t,n){r.reject(t)})},function(e){console.log(">>>Unable to obtain session id "+e),r.reject("Session fail")})},function(e){v&&console.log(">>>Unable to obtain compute context id "+e),r.reject("No context")}),r.promise()},deleteSession:function(){if(null!==a){var n=""===t?{Accept:"application/json","X-CSRF-TOKEN":s}:{Accept:"application/json","X-CSRF-TOKEN":s,Authorization:"bearer "+t};jQuery.ajax({url:e+"/compute/sessions/"+a,type:"DELETE",dataType:"json",contentType:"application/json",headers:n}),a=null}}}}();
